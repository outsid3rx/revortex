# revortex

[Эта же страница на английском](../README.md)

Утилита для автоматической генерации API клиента из исходного кода [Nest](https://nestjs.com/) проекта.
Создан для использования внутри монорепозитория и не требует ручного описания вариантов ответов и параметров в контроллерах.

## Принцип работы

Пакет создает небольшую типизированную обертку для каждого метода в контроллере и переиспользует их типы - это позволяет приложению работать с минимальной конфигурацией.
По этой же причине есть ограничение - между приложениямии должны быть настроены импорты, поэтому revortex в первую очередь может использоваться в монорепозиториях.

## Установка

Приложение должно быть установлено в репозиторий клиентской части приложения:

```shell
# Сам генератор кода
pnpm add -D revortexэ
# Небольшая обертка для работы в рантайме
pnpm add revortex-wrapper
```

## Конфигурация и запуск

Создайте файл `revortex.json` в корне проекта и установите необходимые поля:

### repo

Ссылка на корневую директорию репозитория Nest проекта, например, `../server/`, если репозитории сервера и клиента расположены на одном уровне.

### outDir

Ссылка на директорию, в которую будет сохранен итоговый клиент, например `./lib/`.

### importAliasSrcDir (опционально)

Path alias (если настроен) на директорию `src` серверной части, поможет настроить более явные и короткие импорты. По умолчанию собирается из`repo` и `sourceDir`, как, например `../server/src/`.

### mainPath (опционально)

Если в вашем Nest проекте, `main.ts` файл был перемещен относительно стартового шаблона, нужно указать путь от корневой директории серверной части приложения. По умолчанию: `./src/main.ts`

### sourceDir (опционально)

Если при построении Nest приложения вы организовали расположение модулей отлично от стартового шаблона, нужно указать путь до директории, которая содержит в себе модули, относительный от корневой директории серверной части приложения. По умолчанию: `src/`.

Обычный `revortex.json` файл выглядит следующим образом:

```json
{
  "repo": "../server/",
  "outDir": "./lib/",
  "importAliasSrcDir": "~server/"
}
```

### Запуск

Приложение нужно запускать из одной директории с конфигурационным файлом:

```shell
pnpm exec revortex
```

Дополнительно можно зарегистрировать команду в Taskfile, чтобы запускать генерацию из любой директории и стандартизированным образом:

```yaml
version: '3'

vars:
  WEB_PATH: ./apps/web

tasks:
  generate-api:
    dir: "{{.WEB_PATH}}"
    cmds:
      - pnpm exec revortex
      - prettier -w ./lib/index.ts
```
```shell
task generate-api
```

## Использование

Теперь необходимо создать экземпляр `api` при помощи готовой утилиты и пакета `ky`:

```typescript
import ky from 'ky'
import { apiCall } from 'revortex-wrapper'
import { createApi } from '../lib'

const api = createApi(ky, apiCall)
await api.AppController.getHello({})
```

На данный момент для создания обертки необходим экземпляр `ky`, так как работа самой обертки построена на взаимодействии с этим пакетом.

## Roadmap

- [ ] Добавить поддержку `axios` для создания обертки
- [ ] Добавить поддержку `fetch` для создания обертки
- [ ] Добавить поддержку параметров при запуске приложения вместо конфигурационного файла